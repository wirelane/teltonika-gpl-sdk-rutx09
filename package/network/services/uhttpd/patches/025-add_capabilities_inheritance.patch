Index: uhttpd-2021-03-21-15346de8/CMakeLists.txt
===================================================================
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -37,7 +37,7 @@ ENDIF()
 
 ADD_EXECUTABLE(uhttpd ${SOURCES})
 FIND_LIBRARY(libjson NAMES json-c json)
-TARGET_LINK_LIBRARIES(uhttpd ubox dl json_script blobmsg_json ubus ${libjson} ${LIBS})
+TARGET_LINK_LIBRARIES(uhttpd ubox dl json_script blobmsg_json ubus ${libjson} ${LIBS} cap)
 
 SET(PLUGINS "")
 IF(LUA_SUPPORT)
Index: uhttpd-2021-03-21-15346de8/proc.c
===================================================================
--- a/proc.c
+++ b/proc.c
@@ -364,6 +364,10 @@ bool uh_create_process(struct client *cl
 		close(wfd[1]);
 
 		uh_close_fds();
+
+		if (uh_set_caps() == -1)
+			goto close_wfd;
+
 		cb(cl, pi, url);
 		exit(0);
 	}
Index: uhttpd-2021-03-21-15346de8/ubus_uhttpd.c
===================================================================
--- a/ubus_uhttpd.c
+++ b/ubus_uhttpd.c
@@ -174,6 +174,9 @@ static int internal_lua_api_call(struct
 
 		LUA_SET_BOOLEAN_FIELD("INTERNAL", 1);
 
+		if (uh_set_caps() == -1)
+			goto cleanup;
+
 		if (lua_pcall(L, 1, 1, 0)) {
 			const char *err = lua_tostring(L, -1);
 			(void) write(pipefd[1], err, strlen(err));
Index: uhttpd-2021-03-21-15346de8/utils.c
===================================================================
--- a/utils.c
+++ b/utils.c
@@ -291,3 +291,21 @@ char *uh_htmlescape(const char *str)
 
 	return copy;
 }
+
+int uh_set_caps()
+{
+	int res = 0;
+	cap_t caps = cap_get_proc();
+	cap_value_t newcaps[2] = { CAP_NET_ADMIN, CAP_NET_RAW };
+
+	if (cap_set_flag(caps, CAP_INHERITABLE, 2, newcaps, CAP_SET) == -1) {
+		fprintf(stderr, "Failed to set inheritable capabilities: %s", strerror(errno));
+		res = -1;
+	}
+	if (cap_set_proc(caps) == -1) {
+		fprintf(stderr, "Failed to process inheritable capabilities: %s", strerror(errno));
+		res = -1;
+	}
+
+	return res;
+}
Index: uhttpd-2021-03-21-15346de8/utils.h
===================================================================
--- a/utils.h
+++ b/utils.h
@@ -31,6 +31,7 @@
 #include <alloca.h>
 #include <time.h>
 #include <unistd.h>
+#include <sys/capability.h>
 
 struct uh_addr {
 	uint8_t family;
@@ -74,5 +75,6 @@ bool uh_path_match(const char *prefix, c
 char *uh_split_header(char *str);
 bool uh_addr_rfc1918(struct uh_addr *addr);
 char *uh_htmlescape(const char *src);
+int uh_set_caps();
 
 #endif
