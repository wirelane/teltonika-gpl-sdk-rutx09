From e745782f2835f12992e4b519f8dc1ac768252fab Mon Sep 17 00:00:00 2001
From: Joris Vaisvila <joris.vaisvila@teltonika.lt>
Date: Fri, 25 Oct 2024 09:32:55 +0300
Subject: [PATCH 1/1] fix segfault when exit with wired vlans

---
 hostapd/config_file.c | 9 +++++++++
 src/ap/ap_config.h    | 1 +
 src/ap/vlan_init.c    | 2 +-
 3 files changed, 11 insertions(+), 1 deletion(-)

diff --git a/hostapd/config_file.c b/hostapd/config_file.c
index f138681..a20be3f 100644
--- a/hostapd/config_file.c
+++ b/hostapd/config_file.c
@@ -3411,6 +3411,15 @@ static int hostapd_config_fill(struct hostapd_config *conf,
 				   line, bss->ssid.vlan_naming);
 			return 1;
 		}
+	} else if (os_strcmp(buf, "external_vlan_management") == 0) {
+		errno = 0;
+		char* endptr;
+		long external_vlan_management = strtol(pos, &endptr, 10);
+		if (errno || *endptr != '\0') {
+			wpa_printf(MSG_ERROR, "Line %d: failed to read external_vlan_management: '%s'", line, pos);
+			return 1;
+		}
+		bss->external_vlan_management = external_vlan_management;
 #ifdef CONFIG_FULL_DYNAMIC_VLAN
 	} else if (os_strcmp(buf, "vlan_tagged_interface") == 0) {
 		os_free(bss->ssid.vlan_tagged_interface);
diff --git a/src/ap/ap_config.h b/src/ap/ap_config.h
index c370134..c90ed2e 100644
--- a/src/ap/ap_config.h
+++ b/src/ap/ap_config.h
@@ -303,6 +303,7 @@ struct hostapd_bss_config {
 	unsigned int chan_util_avg_period;
 
 	int ieee802_1x; /* use IEEE 802.1X */
+	int external_vlan_management; /* VLANs applied externaly over ubus request */
 	int eapol_version;
 	int eap_server; /* Use internal EAP server instead of external
 			 * RADIUS server */
diff --git a/src/ap/vlan_init.c b/src/ap/vlan_init.c
index b69f3de..e776067 100644
--- a/src/ap/vlan_init.c
+++ b/src/ap/vlan_init.c
@@ -123,7 +123,7 @@ static void vlan_dynamic_remove(struct hostapd_data *hapd,
 		if (vlan->vlan_id != VLAN_ID_WILDCARD)
 			vlan_dellink(vlan->ifname, hapd);
 #else /* CONFIG_FULL_DYNAMIC_VLAN */
-		if (vlan->vlan_id != VLAN_ID_WILDCARD &&
+		if (vlan->vlan_id != VLAN_ID_WILDCARD && !hapd->conf->external_vlan_management &&
 		    vlan_if_remove(hapd, vlan)) {
 			wpa_printf(MSG_ERROR, "VLAN: Could not remove VLAN "
 				   "iface: %s: %s",
-- 
2.47.0

