--- a/files/lib/mwan3/mwan3.sh
+++ b/files/lib/mwan3/mwan3.sh
@@ -25,6 +25,7 @@ IPv4_REGEX="((25[0-5]|2[0-4][0-9]|[01]?[
 DEFAULT_LOWEST_METRIC=256
 MWAN_HIGHEST_EVENT_METRIC=256
 MAIN_WAN_METRIC=256
+MAIN_POLICY=""
 BACKUPS=0
 
 ACTIVE_WAN=/var/run/mwan3/active_wan
@@ -586,6 +587,11 @@ mwan3_delete_iface_ipset_entries()
 	done
 }
 
+mwan3_update_main_policy()
+{
+	MAIN_POLICY=$(uci -q get mwan3.default_rule.use_policy)
+	[ -z "$MAIN_POLICY" ] && MAIN_POLICY=$(uci -q get mwan3.@rule[0].use_policy)
+}
 
 mwan3_set_policy()
 {
@@ -650,7 +656,8 @@ mwan3_set_policy()
 		fi
 	fi
 	if [ $is_lowest -eq 1 ]; then
-		[ "$2" = "mwan_default" ] && echo "$iface" > "$ACTIVE_WAN"
+		mwan3_update_main_policy
+		[ "$2" = "$MAIN_POLICY" ] && echo "$iface" > "$ACTIVE_WAN"
 		mwan3_push_update -F "mwan3_policy_$policy"
 		mwan3_push_update -A "mwan3_policy_$policy" \
 				  -m mark --mark 0x0/$MMX_MASK \
@@ -1251,90 +1258,126 @@ mwan3_track_clean()
 
 mwan3_find_lowest()
 {
-        local metric interface enabled
-        config_get interface $1 interface
-        config_get enabled $interface enabled
-        [ "$enabled" -eq 1 ] || return 0
-        config_get metric $1 metric 256
-        if [ "$metric" -lt "$MWAN_HIGHEST_EVENT_METRIC" ]; then
-                MWAN_HIGHEST_EVENT_METRIC=$metric
-        fi
+	local metric interface enabled members
+	local member="$1"
+	config_get members $MAIN_POLICY use_member
+	if echo "$members" | grep -wq "$member"; then
+		config_get interface $member interface
+		config_get enabled $interface enabled
+		[ "$enabled" -eq 1 ] || return 0
+		config_get metric $member metric 256
+		if [ "$metric" -lt "$MWAN_HIGHEST_EVENT_METRIC" ]; then
+			MWAN_HIGHEST_EVENT_METRIC=$metric
+		fi
+	fi
 }
+
 mwan3_find_main()
 {
-        local interface metric enabled
-        config_get interface "$1" interface
-        config_get enabled "$interface" enabled
-        [ "$enabled" = "1" ] || return 0
-        config_get metric $1 metric
-        if [ "$metric" -lt "$MAIN_WAN_METRIC" ]; then
-                MAIN_WAN_METRIC=$metric
-                MAIN_WAN=`cat /var/run/mwan3track/"$interface"/STATUS`
-        fi
+	local interface metric enabled members
+	local member="$1"
+	config_get members $MAIN_POLICY use_member
+	if echo "$members" | grep -wq "$member"; then
+		config_get interface "$member" interface
+		config_get enabled "$interface" enabled
+		[ "$enabled" = "1" ] || return 0
+		config_get metric $member metric
+		if [ "$metric" -lt "$MAIN_WAN_METRIC" ]; then
+			MAIN_WAN_METRIC=$metric
+			MAIN_WAN=`cat /var/run/mwan3track/"$interface"/STATUS`
+		fi
+	fi
 }
 
 mwan3_count_backups()
 {
-	for f in /var/run/mwan3/iface_state/* ; do
-		status=$(cat "$f")
+	local status interface members
+	local policy="$1"
+	config_get members "$policy" use_member
+	for member in $members; do
+		config_get interface "$member" interface
+		status=$(cat "/var/run/mwan3/iface_state/$interface" 2>/dev/null)
 		[ "$status" = "online" ] && BACKUPS=$((BACKUPS+1))
 	done
 }
 
+mwan3_iface_belong_to_policy()
+{
+	local policy="$1"
+	local iface="$2"
+	local members member_iface
+
+	config_get members $policy use_member
+
+	for member in $members; do
+		config_get member_iface $member interface
+		[ "$member_iface" = "$iface" ] && echo "$member" && return
+	done
+
+	echo ""
+	return
+}
+
 mwan3_set_event()
 {
-        local metric text wan_name wan_metric
-        local iface=$1
-        config_get metric $iface"_member_mwan" metric 256
-        config_foreach mwan3_find_lowest member
-        if [ "$metric" -eq "$MWAN_HIGHEST_EVENT_METRIC" ]; then
-		echo "$iface" > "$ACTIVE_WAN"
-                ubus call log write_ext "{
-                        \"event\": \"Switched to main WAN ($iface)\",
-                        \"sender\": \"Failover\",
-                        \"table\": 2,
-                        \"write_db\": 1,
-                }"
-        else
-                config_foreach mwan3_find_main member
-                [ "$MAIN_WAN" == "online" ] && return 0
-		wan_name=$(cat "$ACTIVE_WAN")
-		config_get wan_metric $wan_name"_member_mwan" metric
-		[ "$wan_metric" -lt "$metric" ] && return
-		echo "$iface" > "$ACTIVE_WAN"
-                ubus call log write_ext "{
-                        \"event\": \"Switched to backup WAN ($iface)\",
-                        \"sender\": \"Failover\",
-                        \"table\": 2,
-                        \"write_db\": 1,
-                }"
-        fi
+		local metric text wan_name wan_metric
+		local iface=$1
+		mwan3_update_main_policy
+		local member=$(mwan3_iface_belong_to_policy $MAIN_POLICY $iface)
+		[ -z "$member" ] && return
+		config_get metric "$member" metric 256
+		config_foreach mwan3_find_lowest member
+		if [ "$metric" -eq "$MWAN_HIGHEST_EVENT_METRIC" ]; then
+			echo "$iface" > "$ACTIVE_WAN"
+			ubus call log write_ext "{
+				\"event\": \"Switched to main WAN ($iface)\",
+				\"sender\": \"Failover\",
+				\"table\": 2,
+				\"write_db\": 1,
+			}"
+		else
+			config_foreach mwan3_find_main member
+			[ "$MAIN_WAN" == "online" ] && return 0
+			wan_name=$(cat "$ACTIVE_WAN")
+			config_get wan_metric $wan_name"_member_mwan" metric
+			[ "$wan_metric" -lt "$metric" ] && return
+			echo "$iface" > "$ACTIVE_WAN"
+			ubus call log write_ext "{
+				\"event\": \"Switched to backup WAN ($iface)\",
+				\"sender\": \"Failover\",
+				\"table\": 2,
+				\"write_db\": 1,
+			}"
+		fi
 }
 
 mwan3_set_fail_event()
 {
-        local metric
-        config_get metric $1"_member_mwan" metric 256
-        mwan3_count_backups
-        if [ "$BACKUPS" -ge 1 ]; then
+	local metric
+	local iface=$1
+	mwan3_update_main_policy
+	local member=$(mwan3_iface_belong_to_policy $MAIN_POLICY $iface)
+	[ -z "$member" ] && return
+	config_get metric $member metric 256
+	mwan3_count_backups "$MAIN_POLICY"
+	if [ "$BACKUPS" -ge 1 ]; then
 		backup=$(cat "$ACTIVE_WAN")
-		config_get backup_metric $backup"_member_mwan" metric
+		local backup_member=$(mwan3_iface_belong_to_policy $MAIN_POLICY $backup)
+		config_get backup_metric $backup_member metric 1
 		[ "$backup_metric" -lt "$metric" ] && return
 		echo "$backup" > "$ACTIVE_WAN"
-
-                ubus call log write_ext "{
-                        \"event\": \"WAN ($1) is down, switched to backup WAN ($backup)\",
-                        \"sender\": \"Failover\",
-                        \"table\": 2,
-                        \"write_db\": 1,
-                }"
-	 elif [ "$BACKUPS" -eq 0 ]; then
-                ubus call log write_ext "{
-                        \"event\": \"WAN ($1) is down, no more backups to switch\",
-                        \"sender\": \"Failover\",
-                        \"table\": 2,
-                        \"write_db\": 1,
-                }"
-        fi
+			ubus call log write_ext "{
+				\"event\": \"WAN ($iface) is down, switched to backup WAN ($backup)\",
+				\"sender\": \"Failover\",
+				\"table\": 2,
+				\"write_db\": 1,
+			}"
+	elif [ "$BACKUPS" -eq 0 ]; then
+			ubus call log write_ext "{
+				\"event\": \"WAN ($iface) is down, no more backups to switch\",
+				\"sender\": \"Failover\",
+				\"table\": 2,
+				\"write_db\": 1,
+			}"
+	fi
 }
-
