#!/bin/sh

. /lib/functions.sh

SIMCARD_CFG="simcard"
SYSTEM_CFG="system"
LTE_NB="lte_nb"
FOUND=0
DEV_NAME="TRB255"

sep_bands() {
        local value="$1"
        [ -z $value ] && return

        local section="$2"
        local old_prefix="lte_b"
        local nb_band="$LTE_NB${value#"$old_prefix"}"

        uci_add_list "$SIMCARD_CFG" "$section" "$LTE_NB" "$nb_band"
}

manage_lte_bands() {
        local section="$1"
        local band category_lte

        config_get band "$section" band "auto"
        if [ "$band" = "manual" ]; then
                config_get category_lte "$section" category_lte
                if [ -z "$category_lte" ]; then
                        uci_set "$SIMCARD_CFG" "$section" category_lte "m1_nb"
                elif [ "$category_lte" = "m1" ]; then
                        return;
                fi
        fi
        config_list_foreach $section "lte" sep_bands $section
}

look_for_nb() {
        [ -n "$1" ] && FOUND=1
}

look_nb_list() {
        local section="$1"
        config_list_foreach $section "$LTE_NB" look_for_nb
}

config_load "$SYSTEM_CFG"
config_get devicename "system" devicename

[ "$devicename" != "$DEV_NAME" ] && return

config_load "$SIMCARD_CFG"
config_foreach look_nb_list sim
[ $FOUND -eq 0 ] && config_foreach manage_lte_bands sim

uci_commit "$SIMCARD_CFG"

exit 0